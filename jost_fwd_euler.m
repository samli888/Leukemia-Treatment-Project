function [x_tp1, dfdx, dfdu, dgdx] = jost_fwd_euler(t,x_t,d,theta,dt)
%JOST state ODE for 6-MP and 6-TGN leukopoiesis
% this one is for linearization purposes; contains extra return arg dfdu
%   8 state model described in Jost et al. 2020
%   d = dose
%   theta = vector of parameters


if t<14
    u = d;
else
    u = 0;
end


% define matrices and nonlinear components
A = [-theta(1)                0 0 0 0 0 0 0; ...
    theta(1) -theta(2)          0 0 0 0 0 0; ...
    0 theta(3)*theta(4) -theta(5) 0 0 0 0 0; ...
    0 0 0 -theta(7)                 0 0 0 0; ...
    0 0 0 theta(7) -theta(7)          0 0 0; ...
    0 0 0 0 theta(7) -theta(7)          0 0; ...
    0 0 0 0 0 theta(7) -theta(7)          0; ...
    0 0 0 0 0 0 theta(7) -theta(10)];

B = [0.22;0;0;0;0;0;0;0];

f_hat = [0;...
    0;...
    0;...
    theta(7)*((theta(6)/x_t(8))^theta(9))*x_t(4)-theta(7)*theta(8)*((theta(6)/x_t(8))^theta(9))*x_t(3)*x_t(4);...
    0;...
    0;...
    0;...
    0];

x_tp1 = x_t+(A*x_t + B*u + f_hat)*dt;

dfdx = eye(8)+(A + ...
       [0 0 0 0 0 0 0 0;...
       0 0 0 0 0 0 0 0;...
       0 0 0 0 0 0 0 0;...
       0 0 -theta(7)*theta(8)*((theta(6)/x_t(8))^theta(9))*x_t(4) theta(7)*((theta(6)/x_t(8))^theta(9))-theta(7)*theta(8)*((theta(6)/x_t(8))^theta(9))*x_t(3) 0 0 0 -theta(6)*theta(7)*((theta(6)/x_t(8))^(theta(9)-1))*x_t(4)/(x_t(8)^2)+theta(6)*theta(7)*theta(8)*((theta(6)/x_t(8))^(theta(9)-1))*x_t(3)*x_t(4)/(x_t(8)^2);...
       0 0 0 0 0 0 0 0;...
       0 0 0 0 0 0 0 0;...
       0 0 0 0 0 0 0 0;...
       0 0 0 0 0 0 0 0])*dt;

dfdu = B*dt;

dgdx = [0 0 0 0 0 0 0 1];

end